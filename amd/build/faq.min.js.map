{"version":3,"file":"faq.min.js","sources":["../src/faq.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_wunderbyte_table\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from \"core/templates\";\n\nimport {increaseCounter} from \"local_wb_faq/faqnavbar\";\nimport {get_string as getString} from \"core/str\";\nimport Ajax from \"core/ajax\";\n\nconst faqs = {};\n\nconst SELECTORS = {\n  SUPPORTMESSAGE_MODULE: 'div[data-id=\"supportmessage-form\"] input[name=\"module\"][type=\"hidden\"]',\n  SUPPORTMESSAGE_SUPPLEMENT: 'div[data-id=\"supportmessage-form\"] input[name=\"group\"][type=\"hidden\"]',\n};\n\n/**\n * Gets called from mustache template.\n *\n * @param {*} data\n * @param {integer} root\n * @param {string} uid\n */\nexport const init = (data, root, uid) => {\n\n  // Make sure we never run the same init js twice.\n  if (faqs[uid]) {\n    return;\n  }\n\n  faqs[uid] = true;\n\n  render(root, data, uid);\n  addEvents(data, root, uid);\n};\n\n/**\n * Adds Evente to toggle switch\n * @param {*} data\n * @param {integer} root\n * @param {string} uid\n */\nfunction addEvents(data, root, uid) {\n  let select = document.querySelector(\".local_wb_faq_container-\" + uid);\n\n  if (!select) {\n    return;\n  }\n\n  if (select.listener) {\n    select.removeEventListener(\"click\", select.listener);\n  }\n  if (select) {\n    select.addEventListener(\n      \"click\",\n      (select.listener = (e) => {\n\n        setValuesToSelect(e);\n\n        let button = e.target;\n        if (button.dataset.toggle == \"faqcollapse\") {\n\n          if (button.classList.contains(\"collapsed\")) {\n            button.classList.remove(\"collapsed\");\n            document.querySelector(button.dataset.target).classList.add(\"show\");\n            document\n              .querySelector(button.dataset.target)\n              .classList.remove(\"hide\");\n          } else {\n            button.classList.add(\"collapsed\");\n            document.querySelector(button.dataset.target).classList.add(\"hide\");\n            document\n              .querySelector(button.dataset.target)\n              .classList.remove(\"show\");\n          }\n        }\n        if (e.target.dataset.action == \"goto\") {\n          render(e.target.dataset.targetid, data, uid);\n        }\n      })\n    );\n  }\n\n  let searchbox = document.querySelector(\".wb_faq_searchbox-\" + uid);\n\n  if (searchbox) {\n    searchbox.addEventListener(\"click\", (e) => {\n      let button = e.target;\n      // eslint-disable-next-line no-console\n      if (button.dataset.toggle == \"faqcollapse\") {\n\n        if (button.classList.contains(\"collapsed\")) {\n          button.classList.remove(\"collapsed\");\n          document.querySelector(button.dataset.target).classList.add(\"show\");\n          document\n            .querySelector(button.dataset.target)\n            .classList.remove(\"hide\");\n        } else {\n          button.classList.add(\"collapsed\");\n          document.querySelector(button.dataset.target).classList.add(\"hide\");\n          document\n            .querySelector(button.dataset.target)\n            .classList.remove(\"show\");\n        }\n      }\n      if (e.target.dataset.action == \"goto\") {\n        render(e.target.dataset.targetid, data, uid);\n        document\n          .querySelector(\".local_wb_faq-\" + uid)\n          .scrollIntoView({block: \"start\", behavior: \"smooth\"});\n      }\n    });\n  }\n\n  let category = document.querySelector(\"#id_categorypicker\");\n\n  if (category) {\n    category.addEventListener(\"change\", () => {\n      let faqid = category.value;\n      if (category.value == \"\") {\n        faqid = root;\n      }\n\n      render(faqid, data);\n    });\n  }\n}\n\n/**\n * Renders template from jsonobject for the categoryid\n * @param {integer} id\n * @param {*} data\n * @param {string} uid\n */\nfunction render(id, data, uid) {\n\n  let json = data;\n  if (typeof data === 'string') {\n    json = JSON.parse(data);\n  }\n\n  let templatedata = json[id] ?? null;\n\n  if (!templatedata) {\n\n    // eslint-disable-next-line no-console\n    console.log('no templatedata for id: ', id, data);\n\n    return;\n  }\n\n  templatedata.root = id;\n  templatedata.uid = uid;\n\n  if (!templatedata || !templatedata.hasOwnProperty(\"parentid\")) {\n\n    // eslint-disable-next-line no-console\n    console.error('no data or no parentid found', templatedata);\n    return;\n  }\n\n  if (templatedata.parentid == \"\") {\n    templatedata.parenttitle = getString(\"faq\", \"local_wb_faq\");\n  }\n\n  // eslint-disable-next-line no-console\n  console.log('templatedata: ', templatedata);\n\n  // Select Container\n  let container = document.querySelector(\".local_wb_faq-\" + uid);\n\n  if (!container) {\n\n    // eslint-disable-next-line no-console\n    console.log('container not found, selector ', \".local_wb_faq-\" + uid);\n\n    return;\n  }\n\n  // Empty Container\n  container.innerHTML = \"\";\n  // Render\n  Templates.renderForPromise(\"local_wb_faq/faq\", templatedata)\n    .then(({html, js}) => {\n\n      Templates.replaceNodeContents(\".local_wb_faq-\" + uid, html, js);\n\n      // Remove button attribute for\n      const breadcrumbs = container.querySelectorAll('.wb-breadcrumb div');\n\n      breadcrumbs.forEach(breadcrumb => {\n        try {\n          if (breadcrumb.dataset.targetid != 0\n              && !json[breadcrumb.dataset.targetid]) {\n                throw new Error();\n              }\n        } catch (e) {\n          breadcrumb.classList.add('d-none');\n        }\n      });\n\n      const last = breadcrumbs[breadcrumbs.length - 1];\n\n      last.classList.remove(['btn-primary']);\n      last.classList.add(['btn-nolabel']);\n      last.removeAttribute('data-action');\n\n      return;\n    })\n    .catch((e) => {\n      // eslint-disable-next-line no-console\n      console.log(e);\n    });\n}\n\n/**\n * Calls WS Function to get new data after new entries are added\n * @param {string} uid\n * @param {integer} parentid\n */\nexport const reloadData = (uid, parentid) => {\n  loadData(uid, parentid);\n};\n\nexport const loadData = (uid, parentid) =>\n  Ajax.call([\n    {\n      methodname: \"local_wb_faq_get_faq_data\",\n      args: {},\n      done: function(data) {\n        let newdata = JSON.parse(data.json);\n\n        if (!uid) {\n          return newdata;\n        }\n\n        addEvents(newdata, parentid, uid);\n        render(parentid, newdata, uid);\n        return '';\n      },\n      fail: function(ex) {\n        // eslint-disable-next-line no-console\n        console.log(ex);\n      },\n    },\n  ]);\n\n/**\n *\n * @param {Event} e\n */\nfunction setValuesToSelect(e) {\n\n  // With every click, we increase the counter.\n  increaseCounter();\n\n  const moduleElement = document.querySelector(SELECTORS.SUPPORTMESSAGE_MODULE);\n  const supplementElement = document.querySelector(SELECTORS.SUPPORTMESSAGE_SUPPLEMENT);\n\n  if (moduleElement) {\n\n    moduleElement.value = e.target.dataset.module;\n  }\n  if (supplementElement) {\n\n    supplementElement.value = e.target.dataset.supplement;\n  }\n}"],"names":["_interopRequireDefault","obj","__esModule","default","_templates","_ajax","faqs","SELECTORS","SUPPORTMESSAGE_MODULE","SUPPORTMESSAGE_SUPPLEMENT","addEvents","data","root","uid","select","document","querySelector","listener","removeEventListener","addEventListener","e","increaseCounter","moduleElement","supplementElement","value","target","dataset","module","supplement","setValuesToSelect","button","toggle","classList","contains","remove","add","action","render","targetid","searchbox","scrollIntoView","block","behavior","category","faqid","id","json","JSON","parse","templatedata","console","log","hasOwnProperty","error","parentid","parenttitle","getString","container","innerHTML","Templates","renderForPromise","then","_ref","html","js","replaceNodeContents","breadcrumbs","querySelectorAll","forEach","breadcrumb","Error","last","length","removeAttribute","catch","_exports","init","reloadData","loadData","Ajax","call","methodname","args","done","newdata","fail","ex"],"mappings":"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"}