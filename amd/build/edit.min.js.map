{"version":3,"file":"edit.min.js","sources":["../src/edit.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    local_wunderbyte_table\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\nimport ModalForm from 'core_form/modalform';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport {showSuccessNotification, showErrorNotification} from 'local_wb_faq/notifications';\nimport {deleteEntry, toggleVisibility} from 'local_wb_faq/admin';\nimport {reloadData} from 'local_wb_faq/faq';\n\nconst SELECTORS = {\n    GROUPSUBMIT: '[data-action=\"groupSubmit\"]'\n};\n\n/**\n * Gets called from mustache template.\n *\n */\nexport const init = () => {\n\n    // Find all container.\n    const containers = document.querySelectorAll('.local_wb_faq_container');\n\n    containers.forEach(element => {\n        if (!element.dataset.initialized) {\n            element.addEventListener('click', editModalListener);\n            element.dataset.initialized = true;\n        } else {\n\n            // Just to make sure during development that this is not called to often.\n            // eslint-disable-next-line no-console\n            console.log('unnecessary call of init');\n        }\n    });\n};\n\n/**\n * Modal listener to open the edit Modals.\n * @param {*} event\n */\nconst editModalListener = event => {\n    // eslint-disable-next-line no-console\n    console.log('edit.js', event);\n    let button = event.target;\n\n    if (button.tagName.toLowerCase() === 'i') {\n        button = button.parentElement;\n    }\n\n    if (button.classList.contains('local_wb_faq_edit_question')) {\n        // eslint-disable-next-line no-console\n        console.log('question');\n        openEditQuestionsModal(event);\n\n    } else if (button.classList.contains('local_wb_faq_delete_question')) {\n        // eslint-disable-next-line no-console\n        console.log('delete question');\n        confirmDeleteEntry(event);\n    } else if (button.classList.contains('local_wb_faq_toggle_entry_visibility')) {\n        // eslint-disable-next-line no-console\n        console.log('toggle visibility');\n        confirmToggleVisibility(event);\n    } else if (button.classList.contains('local_wb_faq_toggle_category_visibility')) {\n        // eslint-disable-next-line no-console\n        console.log('toggle visibility');\n        confirmToggleVisibility(event);\n    } else if (button.classList.contains('local_wb_faq_edit_category')) {\n        // eslint-disable-next-line no-console\n        console.log('edit category');\n        openEditCategoriesModal(event);\n\n    } else if (button.classList.contains('local_wb_faq_delete_category')) {\n        // eslint-disable-next-line no-console\n        console.log('delete category');\n        confirmDeleteEntry(event);\n    }\n};\n\n/**\n * Opens the Modal to edit questions.\n * @param {*} event the click event\n */\n function openEditQuestionsModal(event) {\n\n    let button = event.target;\n    let entryid = 0;\n    let parentid = 0;\n    let uid = 0;\n\n    if (button.tagName.toLowerCase() !== 'a') {\n        button = button.parentElement;\n    }\n\n    if (button.dataset.id) {\n        entryid = button.dataset.id;\n    }\n\n    if (button.dataset.faqroot) {\n        parentid = button.dataset.faqroot;\n    }\n\n    if (button.dataset.uid) {\n        uid = button.dataset.uid;\n    }\n\n    const modalForm = new ModalForm({\n\n        // Name of the class where form is defined (must extend \\core_form\\dynamic_form):\n        formClass: \"local_wb_faq\\\\form\\\\editQuestionForm\",\n        // Add as many arguments as you need, they will be passed to the form:\n        args: {\n            'id': entryid,\n            'type': 1,\n            'nobuttons': true,\n            'parentid': parentid\n        },\n        // Pass any configuration settings to the modal dialogue, for example, the title:\n        modalConfig: {title: getString('addquestion', 'local_wb_faq')},\n        // DOM element that should get the focus after the modal dialogue is closed:\n        returnFocus: button\n    });\n\n    // Listen to events if you want to execute something on form submit.\n    // Event detail will contain everything the process() function returned:\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        showSuccessNotification();\n        if (uid) {\n            reloadData(uid, parentid);\n        } else {\n            window.location.reload();\n        }\n    });\n\n    // Show the form.\n    modalForm.show().then(() => {\n\n        return;\n    }).catch(e => {\n        // eslint-disable-next-line no-console\n        console.log(e);\n\n        showErrorNotification();\n    });\n}\n\n/**\n * Opens the Modal to edit questions.\n * @param {*} event the click event\n */\n function openEditCategoriesModal(event) {\n\n    let button = event.target;\n    let entryid = 0;\n    let parentid = 0;\n    let uid = 0;\n\n    if (button.tagName.toLowerCase() !== 'a') {\n        button = button.parentElement;\n    }\n\n    if (button.dataset.id) {\n        entryid = button.dataset.id;\n    }\n\n    if (button.dataset.faqroot) {\n        parentid = button.dataset.faqroot;\n    }\n\n    if (button.dataset.uid) {\n        uid = button.dataset.uid;\n    }\n\n    const modalForm = new ModalForm({\n\n        // Name of the class where form is defined (must extend \\core_form\\dynamic_form):\n        formClass: \"local_wb_faq\\\\form\\\\editCategoriesForm\",\n        // Add as many arguments as you need, they will be passed to the form:\n        args: {\n            'id': entryid,\n            'type': 0,\n            'nobuttons': true,\n            'parentid': parentid\n        },\n        // Pass any configuration settings to the modal dialogue, for example, the title:\n        modalConfig: {title: getString('addcategory', 'local_wb_faq')},\n        // DOM element that should get the focus after the modal dialogue is closed:\n        returnFocus: button\n    });\n\n    modalForm.addEventListener('change', e => {\n\n        // eslint-disable-next-line no-console\n        console.log('change', e.target.dataset);\n\n        if (e.target.dataset.onChangeAction == \"reloadForm\") {\n            const button = document.querySelector(SELECTORS.GROUPSUBMIT);\n            modalForm.processNoSubmitButton(button);\n        }\n    });\n\n    // Listen to events if you want to execute something on form submit.\n    // Event detail will contain everything the process() function returned:\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n        const response = e.detail;\n        // eslint-disable-next-line no-console\n        console.log('Response of the modal: ', response);\n\n        showSuccessNotification();\n        if (uid) {\n            reloadData(uid, parentid);\n        } else {\n            window.location.reload();\n        }\n    });\n\n    // Show the form.\n    modalForm.show().then(() => {\n\n        return;\n    }).catch(e => {\n        // eslint-disable-next-line no-console\n        console.log(e);\n\n        showErrorNotification();\n    });\n}\n\n/**\n * @param {*} event\n */\n export function confirmDeleteEntry(event) {\n\n    // eslint-disable-next-line no-console\n    console.log('confirm delete', event);\n\n    let button = event.target;\n    let entryid = 0;\n\n    // We assume we delete a question.\n    if (!((button.tagName.toLowerCase() == 'a')\n        || (button.tagName.toLowerCase() == 'button'))) {\n        button = button.parentElement;\n    }\n    // No difference at the moment between deleting question or category, but there could be.\n    if (button.classList.contains('local_wb_faq_delete_question')) {\n        if (button.dataset.id) {\n            entryid = button.dataset.id;\n        }\n    } else if (button.classList.contains('local_wb_faq_delete_category')) {\n        if (button.dataset.id) {\n            entryid = button.dataset.id;\n        }\n    } else if (button.dataset\n            && button.dataset.action\n            && button.dataset.action == 'delete') {\n                // eslint-disable-next-line no-console\n                console.log('here we delete');\n\n                entryid = button.dataset.targetid;\n    } else {\n        // eslint-disable-next-line no-console\n        console.log('no delete entry to delete', button);\n        return;\n    }\n\n    getStrings([\n        {key: 'confirmdeleteentrytitle', component: 'local_wb_faq'},\n        {key: 'confirmdeleteentrybody', component: 'local_wb_faq'},\n        {key: 'confirmdeleteentry', component: 'local_wb_faq'}\n    ]\n    ).then(strings => {\n\n        // eslint-disable-next-line no-console\n        console.log(strings);\n\n        ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL}).then(modal => {\n\n            modal.setTitle(strings[0]);\n                modal.setBody(strings[1]);\n                modal.setSaveButtonText(strings[2]);\n                modal.getRoot().on(ModalEvents.save, function() {\n\n                    // Looking for the question.\n                    let entry = button.closest('li.accordion-item');\n                    let elementid = 0;\n\n                    // We need to be looking for the category, not a question.\n                    if (!entry) {\n                        entry = button.closest('[data-action=\"goto\"]');\n\n                        if (!entry) {\n                            // If we still don't find the entry, we are in admin mode.\n                            entry = event.target.closest('tr');\n                            elementid = button.dataset.targetid;\n                        } else {\n                            elementid = entry.dataset.targetid;\n                        }\n                    } else {\n                        elementid = entry.dataset.id;\n                    }\n\n                    // This is to verify that we've actually found the right dom element.\n                    if (elementid == entryid) {\n                        entry.remove();\n                        // Todo: We should react only on a success response from delete.\n                        deleteEntry(entryid);\n                        showSuccessNotification();\n                    } else {\n                        // eslint-disable-next-line no-console\n                        console.log('couldnt find right element', elementid, entryid);\n                    }\n                });\n\n                modal.show();\n                return modal;\n        }).catch(e => {\n            // eslint-disable-next-line no-console\n            console.log(e);\n\n            showErrorNotification();\n        });\n        return true;\n    }).catch(e => {\n        // eslint-disable-next-line no-console\n        console.log(e);\n\n        showErrorNotification();\n    });\n}\n\n/**\n * @param {*} event\n */\n export function confirmToggleVisibility(event) {\n\n    // eslint-disable-next-line no-console\n    console.log('confirmToggleVisibility', event.target);\n\n    let button = event.target;\n    let entryid = 0;\n\n    // We assume we delete a question.\n    if (button.tagName.toLowerCase() !== 'a') {\n        button = button.parentElement;\n    }\n\n    // eslint-disable-next-line no-console\n    console.log('ctv', event.target, button.tagName, button);\n\n    // No difference at the moment between deleting question or category, but there could be.\n    if (button.classList.contains('local_wb_faq_toggle_entry_visibility')) {\n        if (button.dataset.id) {\n            entryid = button.dataset.id;\n        }\n    } else if (button.classList.contains('local_wb_faq_toggle_category_visibility')) {\n        if (button.dataset.id) {\n            entryid = button.dataset.id;\n        }\n    } else {\n        // eslint-disable-next-line no-console\n        console.log('no entry to toggle');\n        return;\n    }\n\n    getStrings([\n        {key: 'confirmtogglevisibilitytitle', component: 'local_wb_faq'},\n        {key: 'confirmtogglevisibilitybody', component: 'local_wb_faq'},\n        {key: 'confirmtogglevisibility', component: 'local_wb_faq'}\n    ]\n    ).then(strings => {\n\n        ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL}).then(modal => {\n\n            modal.setTitle(strings[0]);\n                modal.setBody(strings[1]);\n                modal.setSaveButtonText(strings[2]);\n                modal.getRoot().on(ModalEvents.save, function() {\n\n                    // Looking for the question.\n                    let entry = button.closest('li.accordion-item');\n                    let elementid = 0;\n\n                    // We need to be looking for the category, not a question.\n                    if (!entry) {\n                        entry = button.closest('[data-action=\"goto\"]');\n                        elementid = entry.dataset.targetid;\n                    } else {\n                        elementid = entry.dataset.id;\n                    }\n\n                    // This is to verify that we've actually found the right dom element.\n                    if (elementid == entryid) {\n                        // Todo: We should react only on a success response from delete.\n                        toggleVisibility(entryid);\n\n                        let ielement = button.querySelector('i.toggle-visibility');\n\n                        // eslint-disable-next-line no-console\n                        console.log(ielement, button.classList);\n\n                        if (ielement) {\n                            if (ielement.classList.contains('fa-eye-slash')) {\n                                ielement.classList.replace('fa-eye-slash', 'fa-eye');\n                            } else {\n                                ielement.classList.replace('fa-eye', 'fa-eye-slash');\n                            }\n                            showSuccessNotification();\n                        } else {\n                            window.location.reload();\n                        }\n\n\n\n                    } else {\n                        // eslint-disable-next-line no-console\n                        console.log('couldnt find right element');\n                    }\n                });\n\n                modal.show();\n                return modal;\n        }).catch(e => {\n            // eslint-disable-next-line no-console\n            console.log(e);\n\n            showErrorNotification();\n        });\n        return true;\n    }).catch(e => {\n        // eslint-disable-next-line no-console\n        console.log(e);\n\n        showErrorNotification();\n    });\n}"],"names":["SELECTORS","document","querySelectorAll","forEach","element","dataset","initialized","console","log","addEventListener","editModalListener","event","button","target","tagName","toLowerCase","parentElement","classList","contains","entryid","parentid","uid","id","faqroot","modalForm","ModalForm","formClass","args","modalConfig","title","returnFocus","events","FORM_SUBMITTED","window","location","reload","show","then","catch","e","openEditQuestionsModal","confirmDeleteEntry","confirmToggleVisibility","onChangeAction","querySelector","processNoSubmitButton","response","detail","openEditCategoriesModal","action","targetid","key","component","strings","create","type","ModalFactory","types","SAVE_CANCEL","modal","setTitle","setBody","setSaveButtonText","getRoot","on","ModalEvents","save","entry","closest","elementid","remove","ielement","replace"],"mappings":"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"}